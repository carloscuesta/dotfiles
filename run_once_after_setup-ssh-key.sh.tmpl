#!/bin/bash
set -eufo pipefail

{{- if and (eq .chezmoi.os "darwin") .setSshKey }}

sshKeyPath="{{ .chezmoi.homeDir }}/.ssh/{{ .gitSigningKeyName }}"

if [ ! -f "$sshKeyPath" ]; then
  echo "ğŸ”‘  Setting up SSH key"
  ssh-keygen -t ed25519 -C "{{ .email }}" -f "$sshKeyPath"
  echo "âœ…  Created {{ .gitSigningKeyName }} key"
else
  echo "â„¹ï¸  SSH key {{ .gitSigningKeyName }} already exists, skipping creation"
fi

echo "ğŸ”‘  Adding key to agent"
eval "$(ssh-agent -s)"
ssh-add --apple-use-keychain "$sshKeyPath"
echo "âœ…  Added {{ .gitSigningKeyName }} key to agent"

echo "ğŸ™  Uploading SSH key to GitHub"
pbcopy < "$sshKeyPath".pub
echo "âœ…  Copied key contents to clipboard"
echo "ğŸŒ  Opening GitHub"
open https://github.com/settings/ssh/new

{{ end -}}
